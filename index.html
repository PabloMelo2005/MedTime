<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MedTime</title>
    <meta name="description" content="Seu assistente para lembretes de medicamentos.">
    <meta name="theme-color" content="#E0F2F1" />
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="AppImages/android/android-launchericon-192-192.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
</head>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('pwabuilder-sw.js')
            .then(reg => console.log("‚úÖ Service Worker registrado:", reg))
            .catch(err => console.error("‚ùå Erro ao registrar SW:", err));
    }
</script>

<body>
    <div class="app-container">
        <div id="initial-screen" class="screen" style="display: flex;">
            <div class="logo-container">
                <div class="logo"><i class="ph ph-pill"></i></div>
                <h1>MedTime</h1>
                <p>O seu assistente de medica√ß√£o</p>
            </div>
        </div>

        <div id="profile-selection-screen" class="screen profile-screen">
            <h2>Quem est√° usando?</h2>
            <div id="profile-list"></div>
            <button id="btn-go-to-new-profile" class="btn btn-primary">
                <i class="ph ph-plus-circle"></i> Novo Perfil
            </button>
        </div>

        <div id="new-profile-screen" class="screen auth-screen">
            <h2>Novo Perfil</h2>
            <p class="subtitle">Insira o nome completo do utilizador.</p>
            <div class="input-group">
                <label for="profile-name">Nome Completo</label>
                <input type="text" id="profile-name" placeholder="Ex: Maria da Silva">
            </div>
            <div class="btn-group">
                <button id="btn-cancel-new-profile" class="btn btn-secondary">Voltar</button>
                <button id="btn-save-new-profile" class="btn btn-primary">Salvar Perfil</button>
            </div>
        </div>

        <div id="main-screen" class="screen">
            <div class="main-header">
                <p>MedTime de:</p>
                <h2 id="user-name-display">USER</h2>
                <p class="subtitle" id="meds-today-count">Para o dia de hoje, voc√™ possui 3 medicamentos.</p>
            </div>
            <div id="reminders-list"></div>

            <div id="no-reminders" style="display: none;">
                <p>Nenhum medicamento cadastrado.</p>
                <p>Clique em <i class="ph ph-plus"></i> para adicionar.</p>
            </div>

            <div class="fab-container">
                <button id="btn-switch-profile" class="fab danger" title="Trocar Perfil"><i
                        class="ph ph-users"></i></button>
                <button id="btn-test-alarm" class="fab secondary" title="Testar Alarme"><i
                        class="ph ph-bell"></i></button>
                <button id="btn-go-to-settings" class="fab secondary" title="Configura√ß√µes"><i
                        class="ph ph-gear"></i></button>
                <button id="btn-go-to-history" class="fab secondary" title="Hist√≥rico"><i
                        class="ph ph-clipboard-text"></i></button>
                <button id="btn-add-new-med" class="fab" title="Novo Medicamento"><i class="ph ph-plus"></i></button>
            </div>
        </div>

        <div id="new-med-screen" class="screen">
            <h2 id="new-med-title">Insira os dados do novo medicamento</h2>
            <div class="input-group">
                <label for="med-name">Nome</label>
                <input type="text" id="med-name" placeholder="Ex: Sinvastatina">
            </div>
            <div class="input-group">
                <label for="med-time">Hor√°rio</label>
                <input type="time" id="med-time">
            </div>
            <div class="input-group">
                <label for="med-quantity">Quantidade</label>
                <input type="number" id="med-quantity" placeholder="Insira a quantidade de medicamentos">
            </div>
            <div class="input-group">
                <label for="med-prescription-date">Data da Receita (Opcional)</label>
                <input type="date" id="med-prescription-date">
            </div>
            <div class="input-group">
                <label for="med-frequency">Frequ√™ncia</label>
                <select id="med-frequency">
                    <option value="daily">Todos os dias</option>
                    <option value="every_12h">A cada 12 horas</option>
                    <option value="every_8h">A cada 8 horas</option>
                    <option value="every_6h">A cada 6 horas</option>
                </select>
            </div>
            <div class="btn-group">
                <button id="btn-cancel-new-med" class="btn btn-secondary">Cancelar</button>
                <button id="btn-save-new-med" class="btn btn-primary">Salvar</button>
            </div>
        </div>

        <div id="history-screen" class="screen">
            <h2>Medicamentos tomados hoje:</h2>
            <div id="history-list"></div>
            <p id="no-history" style="display: none;">Nenhum medicamento foi tomado hoje.</p>
            <button id="btn-history-return" class="btn btn-secondary" style="margin-top: 2rem;">Retornar</button>
        </div>

        <div id="settings-screen" class="screen">
            <h2>Configura√ß√µes</h2>
            <div class="setting-item">
                <div class="setting-text">
                    <h3>Notifica√ß√µes Push</h3>
                    <p>Permitir notifica√ß√µes mesmo com o app fechado. (Requer permiss√£o)</p>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="toggle-push-notifications">
                    <label for="toggle-push-notifications" class="slider"></label>
                </div>
            </div>
            <div class="setting-item-explanation">
                <p><strong>Nota:</strong> Ativar esta op√ß√£o pedir√° sua permiss√£o. Para que os lembretes funcionem com o
                    navegador fechado, o aplicativo precisa de um <strong>servidor (backend)</strong> e do uso da
                    <strong>API de Push</strong>.
                </p>
            </div>
            <button id="btn-settings-return" class="btn btn-secondary" style="margin-top: 2rem;">Retornar</button>
        </div>
    </div>

    <div id="alarm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ALERTA!</h2>
            <p>Hora de tomar seu medicamento,</p>
            <p id="alarm-user-name">USER!</p>
            <br>
            <p>NOME: <span class="med-info" id="alarm-med-name">Sinvastatina</span></p>
            <p>QUANTIDADE: <span class="med-info" id="alarm-med-quantity">1</span></p>
            <div class="btn-group-modal">
                <button id="btn-close-modal" class="btn-close-modal">Fechar</button>
                <button id="btn-mark-as-taken" class="btn btn-primary btn-modal-taken">Tomei</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Estado da Aplica√ß√£o
                let profiles = JSON.parse(localStorage.getItem('medTimeProfiles')) || [];
                let currentProfileId = localStorage.getItem('medTimeCurrentProfileId') || null;
                let reminders = JSON.parse(localStorage.getItem('medTimeReminders')) || {};
                let history = JSON.parse(localStorage.getItem('medTimeHistory')) || {};
                let pushEnabled = JSON.parse(localStorage.getItem('medTimePushEnabled')) || false;

                const alarmSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-bleep-980.mp3');
                alarmSound.preload = 'auto';

                let notificationInterval;
                let currentAlarmReminder = null;
                let editingReminderIndex = null;

                const VAPID_PUBLIC_KEY = 'BN5KpMkY3axPW2irYg6A6tRxnFDhahdATjsyNEHJ5L5fZG4Hveo5gNviteY7p81C8ZH8ecYKTxmm0UO8X-f3TzY';

                // Sele√ß√£o de Elementos
                const screens = document.querySelectorAll('.screen');
                const initialScreen = document.getElementById('initial-screen');
                const profileSelectionScreen = document.getElementById('profile-selection-screen');
                const newProfileScreen = document.getElementById('new-profile-screen');
                const mainScreen = document.getElementById('main-screen');
                const newMedScreen = document.getElementById('new-med-screen');
                const historyScreen = document.getElementById('history-screen');
                const settingsScreen = document.getElementById('settings-screen');
                const btnGoToSettings = document.getElementById('btn-go-to-settings');
                const btnSettingsReturn = document.getElementById('btn-settings-return');
                const togglePushNotifications = document.getElementById('toggle-push-notifications');
                const profileList = document.getElementById('profile-list');
                const btnGoToNewProfile = document.getElementById('btn-go-to-new-profile');
                const btnSaveNewProfile = document.getElementById('btn-save-new-profile');
                const btnCancelNewProfile = document.getElementById('btn-cancel-new-profile');
                const profileNameInput = document.getElementById('profile-name');
                const btnAddNewMed = document.getElementById('btn-add-new-med');
                const btnSaveNewMed = document.getElementById('btn-save-new-med');
                const btnCancelNewMed = document.getElementById('btn-cancel-new-med');
                const btnGoToHistory = document.getElementById('btn-go-to-history');
                const btnHistoryReturn = document.getElementById('btn-history-return');
                const btnTestAlarm = document.getElementById('btn-test-alarm');
                const btnSwitchProfile = document.getElementById('btn-switch-profile');
                const userNameDisplay = document.getElementById('user-name-display');
                const medsTodayCount = document.getElementById('meds-today-count');
                const remindersList = document.getElementById('reminders-list');
                const noRemindersMessage = document.getElementById('no-reminders');
                const historyList = document.getElementById('history-list');
                const noHistoryMessage = document.getElementById('no-history');
                const medNameInput = document.getElementById('med-name');
                const medTimeInput = document.getElementById('med-time');
                const medQuantityInput = document.getElementById('med-quantity');
                const medPrescriptionDateInput = document.getElementById('med-prescription-date');
                const medFrequencyInput = document.getElementById('med-frequency');
                const newMedTitle = document.getElementById('new-med-title');
                const alarmModal = document.getElementById('alarm-modal');
                const btnCloseModal = document.getElementById('btn-close-modal');
                const btnMarkAsTaken = document.getElementById('btn-mark-as-taken');
                const alarmUserName = document.getElementById('alarm-user-name');

                // Fun√ß√µes Principais
                function navigateTo(screenId) {
                    screens.forEach(screen => screen.style.display = 'none');
                    const targetScreen = document.getElementById(screenId);
                    if (targetScreen) {
                        targetScreen.style.display = 'flex';
                    }
                }

                function saveProfiles() { localStorage.setItem('medTimeProfiles', JSON.stringify(profiles)); }
                function saveReminders() { localStorage.setItem('medTimeReminders', JSON.stringify(reminders)); }
                function saveHistory() { localStorage.setItem('medTimeHistory', JSON.stringify(history)); }
                function savePushEnabled() { localStorage.setItem('medTimePushEnabled', JSON.stringify(pushEnabled)); }

                function urlBase64ToUint8Array(base64String) {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                    const rawData = window.atob(base64);
                    const outputArray = new Uint8Array(rawData.length);
                    for (let i = 0; i < rawData.length; ++i) {
                        outputArray[i] = rawData.charCodeAt(i);
                    }
                    return outputArray;
                }

                function renderProfileSelectionScreen() {
                    profileList.innerHTML = '';
                    if (profiles.length === 0) {
                        profileList.innerHTML = '<p class="subtitle">Nenhum perfil encontrado. Crie um novo para come√ßar.</p>';
                    } else {
                        profiles.forEach(profile => {
                            const profileCard = document.createElement('div');
                            profileCard.className = 'profile-card';
                            profileCard.textContent = profile.name;
                            profileCard.onclick = () => selectProfile(profile.id);
                            profileList.appendChild(profileCard);
                        });
                    }
                }

                function renderMainScreen() {
                    if (!currentProfileId) return navigateTo('profile-selection-screen');
                    const profile = profiles.find(p => p.id === currentProfileId);
                    if (!profile) return navigateTo('profile-selection-screen');
                    const profileReminders = reminders[currentProfileId] || [];
                    const todayKey = new Date().toISOString().split('T')[0];
                    const todayHistory = (history[currentProfileId] && history[currentProfileId][todayKey]) || [];
                    remindersList.innerHTML = '';
                    userNameDisplay.textContent = profile.name;
                    let totalDosesToday = 0;

                    if (profileReminders.length === 0) {
                        noRemindersMessage.style.display = 'block';
                        medsTodayCount.textContent = 'Voc√™ n√£o possui medicamentos cadastrados.';
                    } else {
                        noRemindersMessage.style.display = 'none';
                        profileReminders.sort((a, b) => a.time.localeCompare(b.time));
                        profileReminders.forEach((reminder, index) => {
                            totalDosesToday++;
                            const card = document.createElement('div');
                            card.className = 'reminder-card';
                            const isTaken = todayHistory.some(h => h.id === reminder.id && h.time === reminder.time);
                            if (isTaken) card.classList.add('taken');
                            card.innerHTML = `
                                <div class="info">
                                    <h3>${reminder.name}</h3>
                                    <p>Hor√°rio: ${reminder.time} - Qtd: ${reminder.quantity}</p>
                                    ${reminder.prescriptionDate ? `<p class="prescription-date">Receita de: ${new Date(reminder.prescriptionDate).toLocaleDateString()}</p>` : ''}
                                </div>
                                <div class="actions">
                                    ${isTaken ? '<i class="ph ph-check-circle taken-icon"></i>' : ''}
                                    <button class="edit-btn" data-index="${index}"><i class="ph ph-pencil-simple"></i></button>
                                    <button class="delete-btn" data-index="${index}"><i class="ph ph-trash"></i></button>
                                </div>
                            `;
                            remindersList.appendChild(card);
                        });
                        const takenCount = todayHistory.length;
                        medsTodayCount.textContent = `Tomados hoje: ${takenCount} de ${totalDosesToday}`;
                    }
                }

                function renderHistoryScreen() {
                    if (!currentProfileId) return navigateTo('profile-selection-screen');
                    historyList.innerHTML = '';
                    const todayKey = new Date().toISOString().split('T')[0];
                    const todayHistory = (history[currentProfileId] && history[currentProfileId][todayKey]) || [];
                    if (todayHistory.length === 0) {
                        noHistoryMessage.style.display = 'block';
                    } else {
                        noHistoryMessage.style.display = 'none';
                        const grouped = todayHistory.reduce((acc, dose) => {
                            acc[dose.name] = (acc[dose.name] || 0) + 1;
                            return acc;
                        }, {});
                        for (const name in grouped) {
                            const count = grouped[name];
                            const item = document.createElement('div');
                            item.className = 'history-item';
                            item.innerHTML = `
                                <h3>${name}</h3>
                                <p>Rem√©dios tomados: ${count}</p>
                            `;
                            historyList.appendChild(item);
                        }
                    }
                }

                function showAlarm(reminder) {
                    currentAlarmReminder = reminder;
                    const profile = profiles.find(p => p.id === currentProfileId);
                    alarmUserName.textContent = profile ? profile.name + '!' : 'USER!';
                    document.getElementById('alarm-med-name').textContent = reminder.name;
                    document.getElementById('alarm-med-quantity').textContent = reminder.quantity;
                    alarmModal.style.display = 'flex';

                    try {
                        alarmSound.currentTime = 0;
                        alarmSound.play().catch(error => {
                            console.warn("√Åudio do alarme bloqueado pelo navegador:", error);
                        });
                    } catch (e) {
                        console.error("Erro ao tocar som:", e);
                    }
                }

                function checkReminders() {
                    if (!currentProfileId) return;
                    const profileReminders = reminders[currentProfileId] || [];
                    const now = new Date();
                    const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    const todayKey = now.toISOString().split('T')[0];
                    const todayHistory = (history[currentProfileId] && history[currentProfileId][todayKey]) || [];

                    profileReminders.forEach(reminder => {
                        if (reminder.time === currentTime) {
                            const alreadyTaken = todayHistory.some(h => h.id === reminder.id && h.time === reminder.time);
                            if (!alreadyTaken) {
                                showAlarm(reminder);
                                if (Notification.permission === 'granted') {
                                    const profile = profiles.find(p => p.id === currentProfileId);
                                    if ('serviceWorker' in navigator && navigator.serviceWorker.ready) {
                                        navigator.serviceWorker.ready.then(reg => {
                                            reg.showNotification(`Hora de ${profile.name} tomar ${reminder.name}!`, {
                                                body: `Tomar ${reminder.quantity} comprimido(s).`,
                                                icon: 'https://placehold.co/192x192/00695C/FFFFFF?text=MT',
                                                tag: reminder.id.toString()
                                            });
                                        });
                                    } else {
                                        new Notification(`Hora de ${profile.name} tomar ${reminder.name}!`, {
                                            body: `Tomar ${reminder.quantity} comprimido(s).`,
                                            icon: 'https://placehold.co/192x192/00695C/FFFFFF?text=MT'
                                        });
                                    }
                                }
                            }
                        }
                    });
                }

                // FUN√á√ÉO CORRIGIDA: handlePushSubscription
                async function handlePushSubscription(enable) {
                    console.log('üîî handlePushSubscription - Enable:', enable);

                    if (enable) {
                        // Verificar suporte
                        if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
                            alert('‚ùå Seu navegador n√£o suporta Notifica√ß√µes Push.');
                            pushEnabled = false;
                            togglePushNotifications.checked = false;
                            savePushEnabled();
                            return;
                        }

                        try {
                            // Solicitar permiss√£o
                            console.log('üì± Solicitando permiss√£o de notifica√ß√£o...');
                            const permission = await Notification.requestPermission();
                            console.log('üì± Permiss√£o obtida:', permission);

                            if (permission !== 'granted') {
                                console.warn('‚ö†Ô∏è Permiss√£o de notifica√ß√£o negada.');
                                alert('‚ùå Permiss√£o negada. As notifica√ß√µes push n√£o funcionar√£o.');
                                pushEnabled = false;
                                togglePushNotifications.checked = false;
                                savePushEnabled();
                                return;
                            }

                            // Aguardar Service Worker estar pronto
                            console.log('‚è≥ Aguardando Service Worker...');
                            const reg = await navigator.serviceWorker.ready;
                            console.log('‚úÖ Service Worker pronto:', reg);

                            // Verificar inscri√ß√£o existente
                            let subscription = await reg.pushManager.getSubscription();
                            console.log('üìã Inscri√ß√£o existente?', subscription ? 'Sim' : 'N√£o');

                            if (subscription === null) {
                                // Criar nova inscri√ß√£o
                                console.log('üÜï Criando nova inscri√ß√£o push...');
                                const convertedKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);

                                subscription = await reg.pushManager.subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: convertedKey
                                });
                                console.log('‚úÖ Nova inscri√ß√£o criada com sucesso!');
                            }

                            // Salvar inscri√ß√£o no localStorage
                            const subscriptionJSON = JSON.stringify(subscription);
                            localStorage.setItem('medTimePushSubscription', subscriptionJSON);
                            console.log('üíæ Inscri√ß√£o salva no localStorage');
                            console.log('üìÑ Dados da inscri√ß√£o (primeiros 100 chars):', subscriptionJSON.substring(0, 100) + '...');

                            pushEnabled = true;
                            savePushEnabled();
                            togglePushNotifications.checked = true;

                            alert('‚úÖ Notifica√ß√µes Push ativadas com sucesso!\n\nüîî Agora voc√™ pode testar clicando no bot√£o do sino.');

                        } catch (error) {
                            console.error('‚ùå Erro ao configurar push:', error);
                            console.error('Stack trace:', error.stack);
                            alert(`‚ùå Erro ao ativar notifica√ß√µes:\n\n${error.message}\n\nVerifique o console (F12) para mais detalhes.`);
                            pushEnabled = false;
                            togglePushNotifications.checked = false;
                            savePushEnabled();
                        }

                    } else {
                        // Desativar notifica√ß√µes
                        console.log('üîï Desativando notifica√ß√µes push...');
                        pushEnabled = false;
                        try {
                            const reg = await navigator.serviceWorker.ready;
                            const subscription = await reg.pushManager.getSubscription();
                            if (subscription) {
                                await subscription.unsubscribe();
                                localStorage.removeItem('medTimePushSubscription');
                                console.log('‚úÖ Inscri√ß√£o removida com sucesso');
                            }
                        } catch (e) {
                            console.error('‚ùå Erro ao remover inscri√ß√£o:', e);
                        }
                        savePushEnabled();
                        togglePushNotifications.checked = false;
                    }
                }

                function resetNewMedForm() {
                    editingReminderIndex = null;
                    medNameInput.value = '';
                    medTimeInput.value = '';
                    medQuantityInput.value = '';
                    medPrescriptionDateInput.value = '';
                    medFrequencyInput.value = 'daily';
                    newMedTitle.textContent = 'Insira os dados do novo medicamento';
                    btnSaveNewMed.textContent = 'Salvar';
                }

                function startEditingReminder(index) {
                    editingReminderIndex = index;
                    const profileReminders = reminders[currentProfileId] || [];
                    const reminder = profileReminders[index];
                    if (!reminder) return;
                    medNameInput.value = reminder.name;
                    medTimeInput.value = reminder.time;
                    medQuantityInput.value = reminder.quantity;
                    medPrescriptionDateInput.value = reminder.prescriptionDate || '';
                    medFrequencyInput.value = reminder.frequency || 'daily';
                    newMedTitle.textContent = 'Altere os dados do medicamento';
                    btnSaveNewMed.textContent = 'Atualizar';
                    navigateTo('new-med-screen');
                }

                function selectProfile(profileId) {
                    currentProfileId = profileId;
                    localStorage.setItem('medTimeCurrentProfileId', profileId);
                    navigateTo('main-screen');
                    renderMainScreen();
                }

                function saveNewProfile() {
                    const name = profileNameInput.value.trim();
                    if (name) {
                        const newProfile = { id: Date.now().toString(), name: name };
                        profiles.push(newProfile);
                        saveProfiles();
                        reminders[newProfile.id] = [];
                        history[newProfile.id] = {};
                        saveReminders();
                        saveHistory();
                        profileNameInput.value = '';
                        selectProfile(newProfile.id);
                    } else {
                        alert('Por favor, insira um nome.');
                    }
                }

                function switchProfile() {
                    currentProfileId = null;
                    localStorage.removeItem('medTimeCurrentProfileId');
                    navigateTo('profile-selection-screen');
                    renderProfileSelectionScreen();
                }

                function setupApp() {
                    if ('Notification' in window && Notification.permission === 'granted') {
                        pushEnabled = true;
                    } else {
                        pushEnabled = false;
                    }
                    savePushEnabled();

                    setTimeout(() => {
                        if (currentProfileId && profiles.find(p => p.id === currentProfileId)) {
                            navigateTo('main-screen');
                            renderMainScreen();
                        } else {
                            navigateTo('profile-selection-screen');
                            renderProfileSelectionScreen();
                        }
                    }, 1500);

                    if (notificationInterval) clearInterval(notificationInterval);
                    notificationInterval = setInterval(checkReminders, 60000);
                }

                // FUN√á√ÉO CORRIGIDA: enviarPush (agora como parte do btnTestAlarm)
                async function enviarPush() {
                    console.log('üîî === INICIANDO TESTE DE PUSH ===');

                    // 1. Verificar se h√° inscri√ß√£o salva
                    const subscriptionString = localStorage.getItem('medTimePushSubscription');
                    console.log('üìã Verificando localStorage...');
                    console.log('Inscri√ß√£o encontrada?', subscriptionString ? '‚úÖ SIM' : '‚ùå N√ÉO');

                    if (!subscriptionString) {
                        console.error('‚ùå Nenhuma inscri√ß√£o encontrada no localStorage');
                        alert('‚ùå Inscri√ß√£o de push n√£o encontrada.\n\n‚ö†Ô∏è PASSOS NECESS√ÅRIOS:\n\n1. V√° em Configura√ß√µes ‚öôÔ∏è\n2. Ative "Notifica√ß√µes Push"\n3. Conceda a permiss√£o quando solicitado\n4. Volte e tente novamente\n\nüí° A inscri√ß√£o precisa ser criada primeiro!');
                        return;
                    }

                    try {
                        // 2. Parsear a inscri√ß√£o
                        const subscription = JSON.parse(subscriptionString);
                        console.log('üì¶ Inscri√ß√£o parseada com sucesso');
                        console.log('Endpoint:', subscription.endpoint);

                        // 3. Preparar payload
                        const payload = {
                            name: 'Medicamento Teste',
                            quantity: '1'
                        };
                        console.log('üì§ Payload preparado:', payload);

                        // 4. Enviar para a API da Vercel
                        console.log('üåê Enviando requisi√ß√£o para: /api/send-push');
                        const response = await fetch('/api/send-push', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ subscription, payload })
                        });

                        console.log('üì° Resposta recebida');
                        console.log('Status:', response.status, response.statusText);

                        // 5. Processar resposta
                        const data = await response.json();
                        console.log('üì• Dados da resposta:', data);

                        if (response.ok) {
                            console.log('‚úÖ SUCESSO! Push enviado');
                            alert('‚úÖ Push enviado com sucesso!\n\nüîî Voc√™ deve receber uma notifica√ß√£o em breve.\n\nüí° DICA: Feche o app para testar se funciona com ele fechado!');
                        } else {
                            throw new Error(data.message || data.error || 'Erro desconhecido do servidor');
                        }

                    } catch (error) {
                        console.error('‚ùå ERRO COMPLETO:', error);
                        console.error('Tipo do erro:', error.name);
                        console.error('Mensagem:', error.message);
                        console.error('Stack:', error.stack);

                        let errorMessage = `‚ùå Falha ao enviar push:\n\n${error.message}\n\n`;

                        if (error.message.includes('fetch')) {
                            errorMessage += "‚ö†Ô∏è Verifique sua conex√£o ou se o servidor backend est√° rodando.";
                        }
                        alert(errorMessage);
                    }
                }

                // --- Event Listeners (A√ß√µes do Usu√°rio) ---

                // Navega√ß√£o de Perfil
                btnGoToNewProfile.addEventListener('click', () => navigateTo('new-profile-screen'));
                btnCancelNewProfile.addEventListener('click', () => {
                    navigateTo('profile-selection-screen');
                    renderProfileSelectionScreen();
                });
                btnSaveNewProfile.addEventListener('click', saveNewProfile);
                btnSwitchProfile.addEventListener('click', switchProfile);

                // Navega√ß√£o de Medicamento
                btnAddNewMed.addEventListener('click', () => {
                    resetNewMedForm();
                    navigateTo('new-med-screen');
                });
                btnCancelNewMed.addEventListener('click', () => {
                    resetNewMedForm();
                    navigateTo('main-screen');
                });

                // Salvar Medicamento
                btnSaveNewMed.addEventListener('click', () => {
                    const name = medNameInput.value.trim();
                    const time = medTimeInput.value;
                    const quantity = medQuantityInput.value;
                    const prescriptionDate = medPrescriptionDateInput.value;
                    const frequency = medFrequencyInput.value;

                    if (name && time && quantity) {
                        if (!reminders[currentProfileId]) reminders[currentProfileId] = [];

                        const reminderData = {
                            name,
                            time,
                            quantity,
                            prescriptionDate,
                            frequency
                        };

                        if (editingReminderIndex !== null) {
                            // Editando
                            const originalReminder = reminders[currentProfileId][editingReminderIndex];
                            reminderData.id = originalReminder.id;
                            reminders[currentProfileId][editingReminderIndex] = reminderData;
                        } else {
                            // Novo
                            reminderData.id = Date.now();
                            reminders[currentProfileId].push(reminderData);
                        }

                        saveReminders();
                        renderMainScreen();
                        navigateTo('main-screen');
                        resetNewMedForm();

                    } else {
                        alert('Por favor, preencha nome, hor√°rio e quantidade.');
                    }
                });

                // A√ß√µes na Lista (Editar e Excluir)
                remindersList.addEventListener('click', (e) => {
                    const deleteButton = e.target.closest('.delete-btn');
                    const editButton = e.target.closest('.edit-btn');

                    if (editButton) {
                        const index = editButton.getAttribute('data-index');
                        startEditingReminder(index);
                    } else if (deleteButton) {
                        const index = deleteButton.getAttribute('data-index');
                        if (confirm(`Tem certeza que deseja excluir este lembrete?`)) {
                            reminders[currentProfileId].splice(index, 1);
                            saveReminders();
                            renderMainScreen();
                        }
                    }
                });

                // Hist√≥rico
                btnGoToHistory.addEventListener('click', () => {
                    renderHistoryScreen();
                    navigateTo('history-screen');
                });
                btnHistoryReturn.addEventListener('click', () => navigateTo('main-screen'));

                // Configura√ß√µes e Push
                btnGoToSettings.addEventListener('click', () => {
                    togglePushNotifications.checked = pushEnabled;
                    navigateTo('settings-screen');
                });
                btnSettingsReturn.addEventListener('click', () => navigateTo('main-screen'));

                togglePushNotifications.addEventListener('change', () => {
                    handlePushSubscription(togglePushNotifications.checked);
                });

                // Bot√£o de Teste (Sino): Tenta o Push Backend + Mostra Alarme Visual
                btnTestAlarm.addEventListener('click', () => {
                    // Mostra o alarme visualmente para teste local
                    showAlarm({ id: 'test', name: 'Teste Local', quantity: '1', time: '00:00' });
                    // Dispara a fun√ß√£o de teste de backend
                    enviarPush();
                });

                // Modal de Alarme
                btnCloseModal.addEventListener('click', () => {
                    alarmModal.style.display = 'none';
                    currentAlarmReminder = null;
                });

                btnMarkAsTaken.addEventListener('click', () => {
                    if (currentAlarmReminder && currentProfileId && currentAlarmReminder.id !== 'test') {
                        const todayKey = new Date().toISOString().split('T')[0];

                        if (!history[currentProfileId]) history[currentProfileId] = {};
                        if (!history[currentProfileId][todayKey]) history[currentProfileId][todayKey] = [];

                        const alreadyTaken = history[currentProfileId][todayKey].some(h => h.id === currentAlarmReminder.id && h.time === currentAlarmReminder.time);

                        if (!alreadyTaken) {
                            history[currentProfileId][todayKey].push({
                                ...currentAlarmReminder,
                                takenAt: new Date().toISOString()
                            });
                            saveHistory();
                            renderMainScreen();
                        }
                    }
                    alarmModal.style.display = 'none';
                    currentAlarmReminder = null;
                });

                // Inicia o aplicativo
                setupApp();

            } catch (error) {
                console.error("Ocorreu um erro ao iniciar o aplicativo:", error);
                document.body.innerHTML = `<div style="padding: 20px; text-align: center; font-family: sans-serif;">
                                    <h1>Ocorreu um erro</h1><p>Houve um problema ao carregar o MedTime. Por favor, tente recarregar a p√°gina.</p>
                                    <p style="color: grey; font-size: 0.8em;">Detalhes: ${error.message}</p>
                                </div>`;
            }
        });
    </script>
</body>

</html>