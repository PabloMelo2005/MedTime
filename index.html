<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MedTime</title>
    <meta name="description" content="Seu assistente para lembretes de medicamentos.">
    <meta name="theme-color" content="#E0F2F1" />
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="AppImages/android/android-launchericon-192-192.png">

    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>

    <style>
        .med-row {
            display: grid;
            grid-template-columns: 2fr 1fr 40px;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .med-row input {
            margin-bottom: 0 !important;
        }

        .btn-remove-row {
            background: #FFEBEE;
            color: #D32F2F;
            border: 1px solid #D32F2F;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-add-row {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background: #4DB6AC;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .alarm-med-list-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            border-left: 4px solid #D32F2F;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('pwabuilder-sw.js')
            .then(reg => console.log("✅ Service Worker registrado"))
            .catch(err => console.error("❌ Erro ao registrar SW:", err));
    }
</script>

<body>
    <div class="app-container">
        <div id="initial-screen" class="screen" style="display: flex;">
            <div class="logo-container">
                <div class="logo"><i class="ph ph-pill"></i></div>
                <h1>MedTime</h1>
                <p>O seu assistente de medicação</p>
            </div>
        </div>

        <div id="profile-selection-screen" class="screen profile-screen">
            <h2>Quem está usando?</h2>
            <div id="profile-list"></div>
            <button id="btn-go-to-new-profile" class="btn btn-primary">
                <i class="ph ph-plus-circle"></i> Novo Perfil
            </button>
        </div>

        <div id="new-profile-screen" class="screen auth-screen">
            <h2>Novo Perfil</h2>
            <p class="subtitle">Insira o nome completo do utilizador.</p>
            <div class="input-group">
                <label for="profile-name">Nome Completo</label>
                <input type="text" id="profile-name" placeholder="Ex: Maria da Silva">
            </div>
            <div class="btn-group">
                <button id="btn-cancel-new-profile" class="btn btn-secondary">Voltar</button>
                <button id="btn-save-new-profile" class="btn btn-primary">Salvar Perfil</button>
            </div>
        </div>

        <div id="main-screen" class="screen">
            <div class="main-header">
                <p>MedTime de:</p>
                <h2 id="user-name-display">USER</h2>
                <p class="subtitle" id="meds-today-count">Carregando...</p>
            </div>
            <div id="reminders-list"></div>

            <div id="no-reminders" style="display: none;">
                <p>Nenhum medicamento cadastrado.</p>
                <p>Clique em <i class="ph ph-plus"></i> para adicionar.</p>
            </div>

            <div class="fab-container">
                <button id="btn-switch-profile" class="fab danger" title="Trocar Perfil"><i
                        class="ph ph-users"></i></button>
                <button id="btn-test-alarm" class="fab secondary" title="Testar Alarme"><i
                        class="ph ph-bell"></i></button>
                <button id="btn-go-to-settings" class="fab secondary" title="Configurações"><i
                        class="ph ph-gear"></i></button>
                <button id="btn-go-to-history" class="fab secondary" title="Histórico"><i
                        class="ph ph-clipboard-text"></i></button>
                <button id="btn-add-new-med" class="fab" title="Novo Medicamento"><i class="ph ph-plus"></i></button>
            </div>
        </div>

        <div id="new-med-screen" class="screen">
            <h2 id="new-med-title">Insira os dados</h2>

            <div class="input-group">
                <label for="med-time">Horário do Lembrete</label>
                <input type="time" id="med-time">
            </div>

            <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Medicamentos</label>
            <div id="medications-container">
            </div>

            <button type="button" id="btn-add-med-row" class="btn-add-row">
                <i class="ph ph-plus"></i> Adicionar outro medicamento
            </button>

            <div class="input-group">
                <label for="med-prescription-date">Data da Receita (Opcional)</label>
                <input type="date" id="med-prescription-date">
            </div>

            <div class="input-group">
                <label for="med-frequency">Frequência</label>
                <select id="med-frequency">
                    <option value="daily">Todos os dias</option>
                    <option value="every_12h">A cada 12 horas</option>
                    <option value="every_8h">A cada 8 horas</option>
                    <option value="every_6h">A cada 6 horas</option>
                </select>
            </div>
            <div class="btn-group">
                <button id="btn-cancel-new-med" class="btn btn-secondary">Cancelar</button>
                <button id="btn-save-new-med" class="btn btn-primary">Salvar</button>
            </div>
        </div>

        <div id="history-screen" class="screen">
            <h2>Medicamentos tomados hoje:</h2>
            <div id="history-list"></div>
            <p id="no-history" style="display: none;">Nenhum medicamento foi tomado hoje.</p>
            <button id="btn-history-return" class="btn btn-secondary" style="margin-top: 2rem;">Retornar</button>
        </div>

        <div id="settings-screen" class="screen">
            <h2>Configurações</h2>
            <div class="setting-item">
                <div class="setting-text">
                    <h3>Notificações Push</h3>
                    <p>Permitir notificações mesmo com o app fechado. (Requer permissão)</p>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="toggle-push-notifications">
                    <label for="toggle-push-notifications" class="slider"></label>
                </div>
            </div>
            <div class="setting-item-explanation">
                <p><strong>Nota:</strong> Ativar esta opção pedirá sua permissão. Para que os lembretes funcionem com o
                    navegador fechado, o aplicativo precisa de um <strong>servidor (backend)</strong> e do uso da
                    <strong>API de Push</strong>.
                </p>
            </div>
            <button id="btn-settings-return" class="btn btn-secondary" style="margin-top: 2rem;">Retornar</button>
        </div>
    </div>

    <div id="alarm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ALERTA!</h2>
            <p>Hora de tomar seu medicamento,</p>
            <p id="alarm-user-name" style="font-weight: bold; margin-bottom: 1rem;">USER!</p>

            <div id="alarm-meds-list" style="margin-bottom: 1.5rem; max-height: 200px; overflow-y: auto;">
            </div>

            <div class="btn-group-modal">
                <button id="btn-close-modal" class="btn-close-modal">Fechar</button>
                <button id="btn-mark-as-taken" class="btn btn-primary btn-modal-taken">Tomei</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // --- 1. CONFIGURAÇÕES E ESTADO ---
                const VAPID_PUBLIC_KEY = 'BN5KpMkY3axPW2irYg6A6tRxnFDhahdATjsyNEHJ5L5fZG4Hveo5gNviteY7p81C8ZH8ecYKTxmm0UO8X-f3TzY';

                let profiles = JSON.parse(localStorage.getItem('medTimeProfiles')) || [];
                let currentProfileId = localStorage.getItem('medTimeCurrentProfileId') || null;
                let reminders = JSON.parse(localStorage.getItem('medTimeReminders')) || {};
                let history = JSON.parse(localStorage.getItem('medTimeHistory')) || {};
                let pushEnabled = JSON.parse(localStorage.getItem('medTimePushEnabled')) || false;

                const alarmSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-bleep-980.mp3');
                alarmSound.preload = 'auto';

                let notificationInterval;
                let currentAlarmReminder = null;
                let editingReminderIndex = null;

                // --- 2. SELEÇÃO DE ELEMENTOS DOM ---
                const screens = document.querySelectorAll('.screen');
                const profileList = document.getElementById('profile-list');
                const remindersList = document.getElementById('reminders-list');
                const historyList = document.getElementById('history-list');

                // Botões
                const btnGoToSettings = document.getElementById('btn-go-to-settings');
                const btnSettingsReturn = document.getElementById('btn-settings-return');
                const togglePushNotifications = document.getElementById('toggle-push-notifications');
                const btnTestAlarm = document.getElementById('btn-test-alarm');
                const btnGoToNewProfile = document.getElementById('btn-go-to-new-profile');
                const btnSaveNewProfile = document.getElementById('btn-save-new-profile');
                const btnCancelNewProfile = document.getElementById('btn-cancel-new-profile');
                const btnSwitchProfile = document.getElementById('btn-switch-profile');
                const btnAddNewMed = document.getElementById('btn-add-new-med');
                const btnSaveNewMed = document.getElementById('btn-save-new-med');
                const btnCancelNewMed = document.getElementById('btn-cancel-new-med');
                const btnGoToHistory = document.getElementById('btn-go-to-history');
                const btnHistoryReturn = document.getElementById('btn-history-return');
                const btnAddMedRow = document.getElementById('btn-add-med-row');
                const btnCloseModal = document.getElementById('btn-close-modal');
                const btnMarkAsTaken = document.getElementById('btn-mark-as-taken');

                // Inputs e Displays
                const profileNameInput = document.getElementById('profile-name');
                const userNameDisplay = document.getElementById('user-name-display');
                const medsTodayCount = document.getElementById('meds-today-count');
                const noRemindersMessage = document.getElementById('no-reminders');
                const noHistoryMessage = document.getElementById('no-history');
                const medTimeInput = document.getElementById('med-time');
                const medPrescriptionDateInput = document.getElementById('med-prescription-date');
                const medFrequencyInput = document.getElementById('med-frequency');
                const newMedTitle = document.getElementById('new-med-title');
                const medicationsContainer = document.getElementById('medications-container');
                const alarmModal = document.getElementById('alarm-modal');
                const alarmMedsList = document.getElementById('alarm-meds-list');
                const alarmUserName = document.getElementById('alarm-user-name');

                // --- 3. FUNÇÕES AUXILIARES ---
                function navigateTo(screenId) {
                    screens.forEach(screen => screen.style.display = 'none');
                    const targetScreen = document.getElementById(screenId);
                    if (targetScreen) targetScreen.style.display = 'flex';
                }
                function saveProfiles() { localStorage.setItem('medTimeProfiles', JSON.stringify(profiles)); }
                function saveReminders() { localStorage.setItem('medTimeReminders', JSON.stringify(reminders)); }
                function saveHistory() { localStorage.setItem('medTimeHistory', JSON.stringify(history)); }
                function savePushEnabled() { localStorage.setItem('medTimePushEnabled', JSON.stringify(pushEnabled)); }

                function urlBase64ToUint8Array(base64String) {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                    const rawData = window.atob(base64);
                    const outputArray = new Uint8Array(rawData.length);
                    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
                    return outputArray;
                }

                // --- 4. LÓGICA DE MÚLTIPLOS MEDICAMENTOS (FORM) ---
                function addMedicationRow(name = '', qty = '') {
                    const row = document.createElement('div');
                    row.className = 'med-row';
                    row.innerHTML = `
                        <input type="text" class="med-name-input" placeholder="Nome do remédio" value="${name}">
                        <input type="number" class="med-qty-input" placeholder="Qtd" value="${qty}">
                        <button type="button" class="btn-remove-row"><i class="ph ph-trash"></i></button>
                    `;
                    row.querySelector('.btn-remove-row').addEventListener('click', () => {
                        if (medicationsContainer.children.length > 1) {
                            row.remove();
                        } else {
                            row.querySelector('.med-name-input').value = '';
                            row.querySelector('.med-qty-input').value = '';
                        }
                    });
                    medicationsContainer.appendChild(row);
                }

                function resetNewMedForm() {
                    editingReminderIndex = null;
                    medicationsContainer.innerHTML = '';
                    addMedicationRow();
                    medTimeInput.value = '';
                    medPrescriptionDateInput.value = '';
                    medFrequencyInput.value = 'daily';
                    newMedTitle.textContent = 'Insira os dados';
                    btnSaveNewMed.textContent = 'Salvar';
                }

                // --- 5. FUNÇÕES DE PERFIL (CORRIGIDAS) ---
                function renderProfileSelectionScreen() {
                    profileList.innerHTML = '';
                    if (profiles.length === 0) {
                        profileList.innerHTML = '<p class="subtitle">Nenhum perfil encontrado. Crie um novo para começar.</p>';
                    } else {
                        profiles.forEach(profile => {
                            const profileCard = document.createElement('div');
                            profileCard.className = 'profile-card';
                            profileCard.textContent = profile.name;
                            profileCard.onclick = () => selectProfile(profile.id);
                            profileList.appendChild(profileCard);
                        });
                    }
                }

                function selectProfile(profileId) {
                    currentProfileId = profileId;
                    localStorage.setItem('medTimeCurrentProfileId', profileId);
                    navigateTo('main-screen');
                    renderMainScreen();
                }

                // ESTA FUNÇÃO FALTAVA NA RESPOSTA ANTERIOR:
                function saveNewProfile() {
                    const name = profileNameInput.value.trim();
                    if (name) {
                        const newProfile = { id: Date.now().toString(), name: name };
                        profiles.push(newProfile);
                        saveProfiles();
                        reminders[newProfile.id] = [];
                        history[newProfile.id] = {};
                        saveReminders();
                        saveHistory();
                        profileNameInput.value = '';
                        selectProfile(newProfile.id);
                    } else {
                        alert('Por favor, insira um nome.');
                    }
                }

                // ESTA TAMBÉM:
                function switchProfile() {
                    currentProfileId = null;
                    localStorage.removeItem('medTimeCurrentProfileId');
                    navigateTo('profile-selection-screen');
                    renderProfileSelectionScreen();
                }

                // --- 6. RENDERIZAÇÃO (MAIN E HISTÓRICO) ---
                function renderMainScreen() {
                    if (!currentProfileId) return navigateTo('profile-selection-screen');
                    const profile = profiles.find(p => p.id === currentProfileId);
                    if (!profile) return navigateTo('profile-selection-screen');

                    const profileReminders = reminders[currentProfileId] || [];
                    const todayKey = new Date().toISOString().split('T')[0];
                    const todayHistory = (history[currentProfileId] && history[currentProfileId][todayKey]) || [];

                    remindersList.innerHTML = '';
                    userNameDisplay.textContent = profile.name;
                    let totalDosesToday = 0;

                    if (profileReminders.length === 0) {
                        noRemindersMessage.style.display = 'block';
                        medsTodayCount.textContent = 'Você não possui medicamentos cadastrados.';
                    } else {
                        noRemindersMessage.style.display = 'none';
                        profileReminders.sort((a, b) => a.time.localeCompare(b.time));

                        profileReminders.forEach((reminder, index) => {
                            let medsList = reminder.meds;
                            if (!medsList) medsList = [{ name: reminder.name, quantity: reminder.quantity }];
                            totalDosesToday += medsList.length;

                            const card = document.createElement('div');
                            card.className = 'reminder-card';
                            const isTaken = todayHistory.some(h => h.id === reminder.id && h.time === reminder.time);
                            if (isTaken) card.classList.add('taken');

                            const medsDisplayString = medsList.map(m => `<strong>${m.name}</strong> (${m.quantity})`).join('<br>');

                            card.innerHTML = `
                                <div class="info">
                                    <h3 style="font-size: 1rem; margin-bottom: 5px;">${reminder.time}</h3>
                                    <div style="color: var(--primary-color); font-size: 1.1rem;">${medsDisplayString}</div>
                                    ${reminder.prescriptionDate ? `<p class="prescription-date">Receita de: ${new Date(reminder.prescriptionDate).toLocaleDateString()}</p>` : ''}
                                </div>
                                <div class="actions">
                                    ${isTaken ? '<i class="ph ph-check-circle taken-icon" style="color: var(--primary-color); font-size: 1.5rem;"></i>' : ''}
                                    <button class="edit-btn" data-index="${index}"><i class="ph ph-pencil-simple"></i></button>
                                    <button class="delete-btn" data-index="${index}"><i class="ph ph-trash"></i></button>
                                </div>
                            `;
                            remindersList.appendChild(card);
                        });
                        const takenCount = todayHistory.length;
                        medsTodayCount.textContent = `Agendamentos hoje: ${profileReminders.length}`;
                    }
                }

                function renderHistoryScreen() {
                    if (!currentProfileId) return navigateTo('profile-selection-screen');
                    historyList.innerHTML = '';
                    const todayKey = new Date().toISOString().split('T')[0];
                    const todayHistory = (history[currentProfileId] && history[currentProfileId][todayKey]) || [];

                    if (todayHistory.length === 0) {
                        noHistoryMessage.style.display = 'block';
                    } else {
                        noHistoryMessage.style.display = 'none';
                        todayHistory.forEach(entry => {
                            const item = document.createElement('div');
                            item.className = 'history-item';
                            const medsNames = entry.meds ? entry.meds.map(m => m.name).join(', ') : entry.name;
                            item.innerHTML = `<h3>${entry.time}</h3><p>${medsNames}</p>`;
                            historyList.appendChild(item);
                        });
                    }
                }

                function startEditingReminder(index) {
                    editingReminderIndex = index;
                    const profileReminders = reminders[currentProfileId] || [];
                    const reminder = profileReminders[index];
                    if (!reminder) return;

                    let medsList = reminder.meds;
                    if (!medsList) medsList = [{ name: reminder.name, quantity: reminder.quantity }];

                    medicationsContainer.innerHTML = '';
                    medsList.forEach(m => addMedicationRow(m.name, m.quantity));

                    medTimeInput.value = reminder.time;
                    medPrescriptionDateInput.value = reminder.prescriptionDate || '';
                    medFrequencyInput.value = reminder.frequency || 'daily';
                    newMedTitle.textContent = 'Editar Medicamentos';
                    btnSaveNewMed.textContent = 'Atualizar';
                    navigateTo('new-med-screen');
                }

                // --- 7. LÓGICA DE ALARME E NOTIFICAÇÃO ---
                function showAlarm(reminder) {
                    currentAlarmReminder = reminder;
                    const profile = profiles.find(p => p.id === currentProfileId);
                    alarmUserName.textContent = profile ? profile.name + '!' : 'USER!';

                    alarmMedsList.innerHTML = '';
                    let medsList = reminder.meds;
                    if (!medsList) medsList = [{ name: reminder.name, quantity: reminder.quantity }];

                    medsList.forEach(m => {
                        const item = document.createElement('div');
                        item.className = 'alarm-med-list-item';
                        item.innerHTML = `<span>${m.name}</span> <strong>Qtd: ${m.quantity}</strong>`;
                        alarmMedsList.appendChild(item);
                    });

                    alarmModal.style.display = 'flex';

                    if ('vibrate' in navigator) navigator.vibrate([500, 200, 500]);
                    try { alarmSound.currentTime = 0; alarmSound.play().catch(() => { }); } catch (e) { }
                }

                function checkReminders() {
                    if (!currentProfileId) return;
                    const profileReminders = reminders[currentProfileId] || [];
                    const now = new Date();
                    const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    const todayKey = now.toISOString().split('T')[0];
                    const todayHistory = (history[currentProfileId] && history[currentProfileId][todayKey]) || [];

                    profileReminders.forEach(reminder => {
                        if (reminder.time === currentTime) {
                            const alreadyTaken = todayHistory.some(h => h.id === reminder.id && h.time === reminder.time);
                            if (!alreadyTaken) {
                                showAlarm(reminder);
                                if (Notification.permission === 'granted') {
                                    new Notification(`Hora de tomar medicamentos!`);
                                }
                            }
                        }
                    });
                }

                async function handlePushSubscription(enable) {
                    togglePushNotifications.checked = pushEnabled;
                    if (enable) {
                        try {
                            const perm = await Notification.requestPermission();
                            if (perm === 'granted') {
                                const reg = await navigator.serviceWorker.ready;
                                let sub = await reg.pushManager.getSubscription();
                                if (!sub) {
                                    sub = await reg.pushManager.subscribe({
                                        userVisibleOnly: true,
                                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                                    });
                                }
                                localStorage.setItem('medTimePushSubscription', JSON.stringify(sub));
                                pushEnabled = true;
                                alert("Notificações Ativadas!");
                            } else {
                                pushEnabled = false;
                                alert("Permissão negada.");
                            }
                        } catch (e) {
                            console.error(e);
                            pushEnabled = false;
                        }
                    } else {
                        pushEnabled = false;
                        localStorage.removeItem('medTimePushSubscription');
                    }
                    savePushEnabled();
                    togglePushNotifications.checked = pushEnabled;
                }

                async function enviarPush() {
                    const subStr = localStorage.getItem('medTimePushSubscription');
                    if (!subStr) return alert("Ative as notificações primeiro!");
                    try {
                        await fetch('/api/send-push', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ subscription: JSON.parse(subStr), payload: { name: 'Teste', quantity: '1' } })
                        });
                        alert("Push enviado! Feche o app para testar.");
                    } catch (e) { alert("Erro: " + e.message); }
                }

                // --- 8. CONFIGURAÇÃO INICIAL E EVENT LISTENERS ---

                // Configurações
                if (btnGoToSettings) {
                    btnGoToSettings.addEventListener('click', () => {
                        togglePushNotifications.checked = pushEnabled;
                        navigateTo('settings-screen');
                    });
                }
                if (btnSettingsReturn) btnSettingsReturn.addEventListener('click', () => navigateTo('main-screen'));
                if (togglePushNotifications) togglePushNotifications.addEventListener('change', () => handlePushSubscription(togglePushNotifications.checked));

                // Perfil
                btnGoToNewProfile.addEventListener('click', () => navigateTo('new-profile-screen'));
                btnCancelNewProfile.addEventListener('click', () => { navigateTo('profile-selection-screen'); renderProfileSelectionScreen(); });
                btnSaveNewProfile.addEventListener('click', saveNewProfile);
                btnSwitchProfile.addEventListener('click', switchProfile);

                // Medicamentos
                btnAddNewMed.addEventListener('click', () => { resetNewMedForm(); navigateTo('new-med-screen'); });
                btnCancelNewMed.addEventListener('click', () => { resetNewMedForm(); navigateTo('main-screen'); });
                btnAddMedRow.addEventListener('click', () => addMedicationRow());

                btnSaveNewMed.addEventListener('click', () => {
                    const time = medTimeInput.value;
                    const prescriptionDate = medPrescriptionDateInput.value;
                    const frequency = medFrequencyInput.value;
                    const rows = document.querySelectorAll('.med-row');
                    const meds = [];
                    rows.forEach(row => {
                        const name = row.querySelector('.med-name-input').value.trim();
                        const quantity = row.querySelector('.med-qty-input').value;
                        if (name && quantity) meds.push({ name, quantity });
                    });

                    if (time && meds.length > 0) {
                        if (!reminders[currentProfileId]) reminders[currentProfileId] = [];
                        const reminderData = { time, meds, prescriptionDate, frequency };
                        if (editingReminderIndex !== null) {
                            reminderData.id = reminders[currentProfileId][editingReminderIndex].id;
                            reminders[currentProfileId][editingReminderIndex] = reminderData;
                        } else {
                            reminderData.id = Date.now();
                            reminders[currentProfileId].push(reminderData);
                        }
                        saveReminders(); renderMainScreen(); navigateTo('main-screen'); resetNewMedForm();
                    } else { alert('Preencha o horário e pelo menos um medicamento.'); }
                });

                // Lista e Histórico
                remindersList.addEventListener('click', (e) => {
                    const del = e.target.closest('.delete-btn');
                    const edit = e.target.closest('.edit-btn');
                    if (edit) startEditingReminder(edit.dataset.index);
                    if (del && confirm('Excluir?')) { reminders[currentProfileId].splice(del.dataset.index, 1); saveReminders(); renderMainScreen(); }
                });

                if (btnGoToHistory) btnGoToHistory.addEventListener('click', () => { renderHistoryScreen(); navigateTo('history-screen'); });
                if (btnHistoryReturn) btnHistoryReturn.addEventListener('click', () => navigateTo('main-screen'));

                // Alarme
                btnTestAlarm.addEventListener('click', () => {
                    showAlarm({ id: 'test', meds: [{ name: 'Teste Local', quantity: '1' }], time: '00:00' });
                    enviarPush();
                });
                btnCloseModal.addEventListener('click', () => { alarmModal.style.display = 'none'; currentAlarmReminder = null; alarmSound.pause(); });
                btnMarkAsTaken.addEventListener('click', () => {
                    if (currentAlarmReminder && currentProfileId && currentAlarmReminder.id !== 'test') {
                        const todayKey = new Date().toISOString().split('T')[0];
                        if (!history[currentProfileId]) history[currentProfileId] = {};
                        if (!history[currentProfileId][todayKey]) history[currentProfileId][todayKey] = [];
                        if (!history[currentProfileId][todayKey].some(h => h.id === currentAlarmReminder.id && h.time === currentAlarmReminder.time)) {
                            history[currentProfileId][todayKey].push({ ...currentAlarmReminder, takenAt: new Date().toISOString() });
                            saveHistory(); renderMainScreen();
                        }
                    }
                    alarmModal.style.display = 'none'; currentAlarmReminder = null; alarmSound.pause();
                });

                // Inicialização
                document.getElementById('initial-screen').addEventListener('click', () => {
                    if (currentProfileId && profiles.find(p => p.id === currentProfileId)) { navigateTo('main-screen'); renderMainScreen(); }
                    else { navigateTo('profile-selection-screen'); renderProfileSelectionScreen(); }
                });

                setTimeout(() => {
                    if (currentProfileId && profiles.find(p => p.id === currentProfileId)) { navigateTo('main-screen'); renderMainScreen(); }
                    else { navigateTo('profile-selection-screen'); renderProfileSelectionScreen(); }
                }, 1500);

                notificationInterval = setInterval(checkReminders, 60000);

            } catch (error) {
                console.error("Erro fatal:", error);
                document.body.innerHTML = `<div style="padding:20px;text-align:center;"><h1>Erro</h1><p>${error.message}</p></div>`;
            }
        });
    </script>
</body>

</html>